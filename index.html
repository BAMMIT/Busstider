<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Busstider</title>

<style>
body {
    margin: 0;
    font-family: system-ui, sans-serif;
    background: #f3f4f6;
}

.columns {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

@media (max-width: 768px) {
    .columns {
        grid-template-columns: 1fr;
    }
}

.column-title {
    font-size: 16px;
    font-weight: 600;
    margin-bottom: 10px;
}
    
.wrapper {
    max-width: 750px;
    margin: 20px auto;
    padding: 10px;
}

.stop-card {
    background: white;
    border-radius: 14px;
    padding: 18px;
    margin-bottom: 25px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.06);
}

.stop-header {
    font-size: 20px;
    font-weight: 600;
    margin-bottom: 15px;
}

.bus-item {
    display: flex;
    justify-content: space-between;
    padding: 12px;
    border-radius: 10px;
    background: #f9fafb;
    margin-bottom: 8px;
}

.bus-line {
    font-weight: 600;
}

.bus-direction {
    font-size: 13px;
    color: #666;
}

.bus-time {
    text-align: right;
    font-weight: 600;
}

.early { color: #059669; }
.late { color: #dc2626; }
.on-time { color: #111827; }

.canceled {
    color: #dc2626;
    font-weight: 600;
}

.footer {
    text-align: center;
    font-size: 12px;
    color: #888;
    margin-top: 10px;
}
</style>
</head>

<body>

<div class="wrapper" id="app"></div>

<script>
const API_KEY = "d04e6df880fd4f33bd14a706425b0994";

function getParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        stops: (params.get("stop") || "").split(","),
        type: params.get("type") || "arrivals"
    };
}

function formatTime(dateString) {
    const date = new Date(dateString);
    return date.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });
}

function buildRow(item) {
    const scheduled = formatTime(item.scheduled);
    const realtime = formatTime(item.realtime);
    const delay = item.delay;
    const canceled = item.canceled;

    let statusClass = "on-time";
    let timeText = realtime;

    if (canceled) {
        timeText = "Inställd";
    } else if (delay < 0) {
        statusClass = "early";
        timeText = `${realtime} (${Math.abs(delay)} min tidig)`;
    } else if (delay > 0) {
        statusClass = "late";
        timeText = `${realtime} (+${Math.round(delay/60)} min)`;
    }

    return `
        <div class="bus-item">
            <div>
                <div class="bus-line">Linje ${item.route.designation}</div>
                <div class="bus-direction">Mot ${item.route.direction}</div>
            </div>
            <div class="bus-time ${statusClass}">
                ${canceled ? `<span class="canceled">Inställd</span>` : timeText}
                <div style="font-size:12px;color:#888;font-weight:400;">
                    Tidtabell: ${scheduled}
                </div>
            </div>
        </div>
    `;
}
    
async function fetchStop(stopId, type) {
    const endpoint = `https://realtime-api.trafiklab.se/v1/${type}/${stopId}?key=${API_KEY}`;
    const response = await fetch(endpoint);
    return response.json();
}

async function loadData() {
    const { stops } = getParams();
    const container = document.getElementById("app");
    container.innerHTML = "";

    for (const stop of stops) {
        if (!stop) continue;

        try {
            const arrivalsData = await fetchStop(stop, "arrivals");
            const departuresData = await fetchStop(stop, "departures");

            const stopName = arrivalsData.stops[0]?.name || "Hållplats";

            let html = `
                <div class="stop-card">
                    <div class="stop-header">${stopName}</div>
                    <div class="columns">
            `;

            // === Ankomster (vänster) ===
            html += `<div>
                        <div class="column-title">Ankomster</div>`;

            arrivalsData.arrivals.slice(0, 6).forEach(item => {
                html += buildRow(item);
            });

            html += `</div>`;

            // === Avgångar (höger) ===
            html += `<div>
                        <div class="column-title">Avgångar</div>`;

            departuresData.departures.slice(0, 6).forEach(item => {
                html += buildRow(item);
            });

            html += `</div></div></div>`;

            container.innerHTML += html;

        } catch {
            container.innerHTML += `<div class="stop-card">Kunde inte hämta hållplats ${stop}</div>`;
        }
    }

    container.innerHTML += `<div class="footer">Uppdateras automatiskt var 30:e sekund</div>`;
}

loadData();
setInterval(loadData, 30000);
</script>

</body>
</html>
